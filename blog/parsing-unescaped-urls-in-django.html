<!DOCTYPE html>
<html lang="en">
<head>
          <title>datapythonista blog - Parsing unescaped urls in django</title>
        <meta charset="utf-8" />
        <link href="https://datapythonista.github.io/blog/atom.xml" type="application/atom+xml" rel="alternate" title="datapythonista blog Full Atom Feed" />




    <meta name="tags" content="Django" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://datapythonista.github.io/blog/">datapythonista blog <strong>about me</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li class="active"><a href="https://datapythonista.github.io/blog/category/misc.html">misc</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://datapythonista.github.io/blog/parsing-unescaped-urls-in-django.html" rel="bookmark"
         title="Permalink to Parsing unescaped urls in django">Parsing unescaped urls in django</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2009-02-19T15:40:00+00:00">
      Thu 19 February 2009
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://datapythonista.github.io/blog/author/marc.html">Marc</a>
    </address>
    <div class="category">
        Category: <a href="https://datapythonista.github.io/blog/category/misc.html">misc</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://datapythonista.github.io/blog/tag/django.html">Django</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Modern browsers escape urls automatically before sending them to the server, but what happens if your application serves http requests to clients that doesn't escape urls?</p>
<p>The answer is that can get unexpected results if you server works in Django (and probably in any python framework/application). That's because python's BaseHTTPServer.BaseHTTPRequestHandler handles urls according to standards, not from a human point of view.</p>
<p>Let's see with an example, consider the next request:</p>
<p><code>http://vaig.be/identify_myself?name=Marc Garcia&amp;country=Catalonia</code></p>
<p>if you request it with a browser, it will escape the space in the url, so the server will get:</p>
<p><code>http://vaig.be/identify_myself?name=Marc%20Garcia&amp;country=Catalonia</code></p>
<p>but what if the client uses, for example, python's urllib2.urlopen without escaping (using urllib.quote)? Of course it is a mistake, but you, as server side developer can't control your clients.</p>
<p>In that case the whole request that server receives is:</p>
<p><code>GET http://vaig.be/identify_myself?name=Marc Garcia&amp;country=Catalonia HTTP/1.1</code></p>
<p>and after being processed (splitted) by python's BaseHTTPServer.BaseHTTPRequestHandler, what we'll get from django is:</p>
<p><code>
request.method == 'GET'
request.META['QUERY_STRING'] == 'name=Marc'
request.META['SERVER_PROTOCOL'] == 'Garcia&amp;country=Catalonia HTTP/1.1'
</code></p>
<p>so our request.GET dictionary will look like:</p>
<p><code>request.GET == {'name': 'Marc'}</code></p>
<p>what is not the expected value (from a human point of view).</p>
<p>So, what we can do for avoiding this result is quite easy (and of course tricky), and is getting the GET values not from django request.GET dictionary but from the one returned by this function:</p>
<p><code>
def _manual_GET(request):
&nbsp;&nbsp;&nbsp;&nbsp;if ' ' in request.META['SERVER_PROTOCOL']:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;query_string = ' '.join(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[request.META['QUERY_STRING']] +
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.META['SERVER_PROTOCOL'].split(' ')[:-1]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args = query_string.split('&amp;')
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result = {}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for arg in args:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key, value = arg.split('=', 1)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[key] = value
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return result
&nbsp;&nbsp;&nbsp;&nbsp;else:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return request.GET
</code></p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>